---
title: "Epi Final"
author: "Margaret Patterson"
date: "12/13/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages and data import
```{r}
library(tidyverse)
library(stringr)
library(dplyr)
library(lme4)
library(broom)
library(scales)
library(readxl)
library(broom.mixed)
library(ggplot2)

mask <- read_csv("nytimes_covid_masks.csv")   
colleges <- read_csv("nytimes_covid_college_cases.csv")
recent <- read_csv("us-counties-recent.csv")  
election <- read_csv("countypres_2000-2020.csv")
calicoll <- read_excel("colleges.xlsx")
```


#Initial clean
```{r}
set.seed(416)

#county_state (for joining), matching fips, cleaning imported data
mask <- mask %>%
  mutate(fips = str_pad(COUNTYFP, 5, side = c("left"), pad = "0")) %>%
  select(fips, NEVER, ALWAYS) %>%
  rename_all(str_to_lower)

colleges <- colleges %>%
  mutate(county_state = paste(county, state, sep = ", ")) %>%
  select(state, county, city, ipeds_id, college, cases, cases_2021, county_state)

recent <- recent %>%
  mutate(county_state = paste(county, state, sep = ", "))

election <- election %>%
  mutate(fips = str_pad(county_fips, 5, side = c("left"), pad = "0")) %>%
  select(fips, candidate, party, candidatevotes, totalvotes, fips)

calicoll <- calicoll %>%
  mutate(fips = str_pad(fips, 5, side = c("left"), pad = "0")) %>%
  mutate(fips = as.character(fips))
```

#Joins
```{r}
recentcoll <- full_join(recent, colleges, by = "county_state") #recent, colleges
collrecoll <- full_join(recentcoll, election, by = "fips") #recent, colleges, election
addcali <- full_join(collrecoll, calicoll, by = "fips") #recent, colleges, election, Cali - uses excel
addmask <- full_join(addcali, mask, by = "fips")
```

#Clean new dataset
```{r}
cdf <- addmask %>%
  na.omit(college.x) %>%
  na.omit(`total enrollment`) %>%
  select(date, college.x, city.x, state.x, county.x, `county pop`, fips, cases.x, deaths, ipeds_id.x, `total enrollment`, `student vax`,
         cases.y, cases_2021, candidate, party, candidatevotes, totalvotes, always, never) %>%
  rename(college = college.x) %>%
  rename(ipeds_id = ipeds_id.x) %>%
  rename(city = city.x) %>%
  rename(county = county.x) %>%
  rename(state = state.x) %>%
  rename(cas_cty = cases.x) %>%
  rename(dth_cty = deaths) %>%
  rename(cas_coll = cases.y) %>%
  rename(cas_coll_21 = cases_2021) %>%
  mutate(partyratio = candidatevotes/totalvotes) %>%
  mutate(cs_cty_ratio = (cas_cty/`county pop`)) %>%
  mutate(dth_cty_ratio = (dth_cty/`county pop`)) %>%
  mutate(cs_collratio = (cas_coll/`total enrollment`)) %>%
  mutate(cs_coll_21_ratio = (cas_coll_21/`total enrollment`)) %>%
  group_by(college) 
```

#Finding cA colleges
```{r}
california <- cdf %>%  #75
  filter(state == "California") %>%
  nest()
```

#Filtering out large duplicates, filter to 13 with no vax info
```{r}
ncdf <- cdf %>%
  filter(ipeds_id == c("110617", "110583", "110608", "121150", "120254", "122597", "122755", 
                       "110635", "110644", "110662", "123961", "120883", "122612")) %>%
  group_by(ipeds_id) %>%
  mutate(n = n()) %>%
  select(date, college, ipeds_id, cas_cty, dth_cty, `county pop`, cas_coll, cas_coll_21, 
         `total enrollment`, `student vax`, party, candidate, candidatevotes, totalvotes, always, never, partyratio, cs_cty_ratio, 
         dth_cty_ratio, cs_collratio, cs_coll_21_ratio, n) %>%
  nest() %>%
  unnest()

ncdf

```

#Models
```{r}

```



